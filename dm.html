<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/2.5.94/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">
    <link rel="stylesheet" href="https://unpkg.com/buefy/dist/buefy.min.css">
    <script src="https://www.gstatic.com/firebasejs/5.11.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.11.0/firebase-firestore.js"></script>
    <script src="firebase.js"></script>
  </head>
  <body>
    <div id="app">
      <h1>Control Panel</h1>
      <section class="section">
        <h2>num</h2>
        <b-field grouped>
          <b-numberinput v-model="num"></b-numberinput>
          <div class="control">
            <button class="button is-info" @click="reset">更新</button>
          </div>
        </b-field>
        <div class="list">
          <div class="list-item" v-for="unit in units">
            <b-checkbox v-model="unit.visible" @input="toggle(unit)">
              {{ unit.type }}
              {{ unit.name }}
            </b-checkbox>
          </div>
        </div>
      </section>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://unpkg.com/buefy/dist/buefy.min.js"></script>
    <script>
      var vm = new Vue({
        el: '#app',
        data: {
          units: [],
          num: 1,
        },
        methods: {
          toggle(unit) {
            db.collection('units').doc(unit.key).update({
              visible: unit.visible,
            })
            .catch((err) => {
              alert(err);
            });
          },
          reset() {
            const pos = [];
            while (pos.length < 15) {
              const x = Math.floor(Math.random() * 11);
              const y = Math.floor(15 + 3 * Math.log(1 - Math.random()));
              if (pos.every(([px, py]) => px !== x || py !== y)) {
                pos.push([x,y]);
              }
            }
            let i = 0;
            for (const unit of this.units) {
              if (unit.type === 'MONSTER') {
                const [x, y] = pos[i];
                i++;
                db.collection('units').doc(unit.key).update({x, y});
              }
            }
          }
        },
        created() {
          db.collection('units').get().then((snapshot) => {
            snapshot.forEach((doc) => {
              const key = doc.id;
              let {type, visible, x, y, name, hp, damage} = doc.data();
              this.units.push({key, type, visible, x, y, name, hp, damage});
            });
          });
        },
      });
    </script>
  </body>
</html>
