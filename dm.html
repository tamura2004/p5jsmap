<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/2.5.94/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">
    <link rel="stylesheet" href="https://unpkg.com/buefy/dist/buefy.min.css">
    <script src="https://www.gstatic.com/firebasejs/5.11.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.11.0/firebase-firestore.js"></script>
    <script src="firebase.js"></script>
  </head>
  <body>
    <div id="app">
      <section class="section">
        <b-field label="マップ">
          <b-select v-model="filename" @input="changeMap">
            <option v-for="map in battlemaps" :value="map.filename">
              {{ map.name }}
            </option>
          </b-select>
        </b-field>
        <h1>モンスター</h1>
        <b-field grouped>
          <b-numberinput v-model="num"></b-numberinput>
          <div class="control">
            <button class="button is-info" @click="reset">更新</button>
          </div>
        </b-field>
        <div class="list">
          <div class="list-item" v-for="monster in monsters">
            <b-checkbox v-model="monster.visible" @input="toggle(monster)">
              {{ monster.type }}
              {{ monster.name }}
            </b-checkbox>
          </div>
        </div>
      </section>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://unpkg.com/buefy/dist/buefy.min.js"></script>
    <script>
      var vm = new Vue({
        el: '#app',
        data: {
          units: [],
          battlemaps: [],
          filename: 'map001.png',
          num: 4,
        },
        computed: {
          monsters() {
            return this.units
              .filter((unit) => unit.type === 'MONSTER')
              .sort((a, b) => a.index > b.index ? 1 : -1);
          },
        },
        methods: {
          toggle(unit) {
            db.collection('units').doc(unit.key).update({
              visible: unit.visible,
            })
            .catch((err) => {
              alert(err);
            });
          },
          changeMap() {
            db.collection('battlemaps').doc('selected').update({filename: this.filename});
            console.log(this.filename);
          },
          reset() {
            let pos = [];
            while (pos.length < this.num) {
              const x = Math.floor(Math.random() * 11);
              const y = Math.floor(15 + 2 * Math.log(1 - Math.random()));
              if (pos.every(p => p.x !== x || p.y !== y)) {
                pos.push({x, y});
              }
            }
            pos = pos.sort((a, b) => a.y * 11 + a.x > b.y * 11 + b.x ? 1 : -1);
            let i = 0;
            
            for (const monster of this.monsters) {
              if (i < this.num) {
                const x = pos[i].x;
                const y = pos[i].y;
                const visible = true;
                i++;
                db.collection('units').doc(monster.key).update({x, y, visible});
              } else {
                const visible = false;
                db.collection('units').doc(monster.key).update({visible});
              }
            }
          }
        },
        created() {
          db.collection('battlemaps').onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
              const key = change.doc.id;
              const data = change.doc.data();
              if (change.type === 'added') {
                if (key === 'selected') {
                  this.mapid = data.mapid;
                } else {
                  let {name, filename, index} = data;
                  this.battlemaps.push({key, name, filename, index});
                }
              }
            });
          });
          db.collection('units').onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
              const key = change.doc.id;
              const data = change.doc.data();
              if (change.type === 'added') {
                let {type, visible, x, y, name, hp, damage, index} = data;
                this.units.push({key, type, visible, x, y, name, hp, damage, index});
              } else if (change.type === 'modified') {
                let {visible, x, y} = data;
                const unit = this.units.find((unit) => unit.key === key);
                Object.assign(unit, {visible, x, y});
              }
            });
          });
          //   snapshot.forEach((doc) => {
          //     const key = doc.id;
          //     let {type, visible, x, y, name, hp, damage, index} = doc.data();
          //     this.units.push({key, type, visible, x, y, name, hp, damage, index});
          //   });
          // });
          // db.collection('units').get().then((snapshot) => {
          //   snapshot.forEach((doc) => {
          //     const key = doc.id;
          //     let {type, visible, x, y, name, hp, damage, index} = doc.data();
          //     this.units.push({key, type, visible, x, y, name, hp, damage, index});
          //   });
          // });
        },
      });
    </script>
  </body>
</html>
